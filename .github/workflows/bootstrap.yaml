name: Check packages

on:
  push:
    paths:
      - 'packages/**'

jobs:
  changed-files:
    name: 'Get changed files'
    runs-on: ubuntu-latest

    outputs:
      any_changed: ${{ steps.changed_files.any_changed }}
      packages: ${{ steps.changed_files.outputs.all_changed_files }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Get all changed files
        id: changed_files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            packages/**
          dir_names: "true"
          dir_names_exclude_current_dir: "true"

      - name: Print modified files
        run: echo ${{ toJSON(steps.changed_files.any_changed) }} -- ${{ toJSON(steps.changed_files.outputs.all_changed_files) }}

  run-npm-bootstrap:
    name: 'Run npm bootstrap in modified package'
    runs-on: ubuntu-latest

    needs: changed-files

    if: ${{ needs.changed-files.outputs.any_changed }}

    strategy:
      matrix:
        package: ${{ needs.changed-files.outputs.packages }}

    steps:
      - name: Check out ${{ matrix.package }}
        uses: actions/checkout@v4
        with:
          repository: diplodoc-platform/${{ matrix.package }}

      - name: Run npm bootstrap
        run: npm run bootstrap
