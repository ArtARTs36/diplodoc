name: Check packages

on:
  push:
    paths:
      - 'packages/**'

jobs:
  changed-files:
    name: 'Get changed files'
    runs-on: ubuntu-latest

    outputs:
      any_changed: ${{ steps.changed_files.any_changed }}
      packages: ${{ steps.split_files.outputs.build }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Get all changed files
        id: changed_files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            packages/**
          dir_names: "true"
          dir_names_exclude_current_dir: "true"

      - uses: danyow/json-matrix-builder@main
        id: split_files
        with:
          str: ${{ steps.changed_files.outputs.all_changed_files }}
          separator: space

      - name: Print modified files
        run: echo ${{ toJSON(steps.changed_files.any_changed) }} -- ${{ toJSON(steps.changed_files.outputs.all_changed_files) }}

  run-npm-bootstrap:
    name: 'Run npm bootstrap in modified package'
    runs-on: ubuntu-latest

    needs: changed-files

    strategy:
      matrix:
        module: ${{ fromJSON(needs.changed-files.outputs.packages) }}
        include:
          - module: 'packages/test'
            repo: 'ggg'
          - module: 'packages/test1'
            repo: 'ggg'
          - module: 'packages/components'
            repo: git@github.com:diplodoc-platform/components.git
          - module: 'packages/transform'
            repo: git@github.com:diplodoc-platform/transform.git
          - module: 'packages/cli'
            repo: git@github.com:diplodoc-platform/cli.git
          - module: 'packages/client'
            repo: git@github.com:diplodoc-platform/client.git
          - module: 'packages/gh-docs'
            repo: git@github.com:diplodoc-platform/gh-docs.git
          - module: 'packages/sentenizer'
            repo: git@github.com:diplodoc-platform/sentenizer.git
          - module: 'packages/translation'
            repo: git@github.com:diplodoc-platform/translation.git


    steps:
      - name: Check out ${{ matrix.module }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}

      - name: Run npm bootstrap
        run: npm run bootstrap
